<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Look Think Make</title><link href="http://www.elfnor.com/" rel="alternate"></link><link href="http://www.elfnor.com/feeds/make-python-micropython-3dprint.atom.xml" rel="self"></link><id>http://www.elfnor.com/</id><updated>2016-10-21T22:00:00+13:00</updated><entry><title>PyBoard Datalogger</title><link href="http://www.elfnor.com/pyboard-datalogger.html" rel="alternate"></link><published>2016-10-21T22:00:00+13:00</published><updated>2016-10-21T22:00:00+13:00</updated><author><name>elfnor</name></author><id>tag:www.elfnor.com,2016-10-21:pyboard-datalogger.html</id><summary type="html">&lt;p&gt;&lt;img alt="data-logger open" src="./images/data_logger_open.JPG" /&gt;&lt;/p&gt;
&lt;p&gt;I've been reading Sandor Katz's book &lt;a href="http://www.wildfermentation.com/the-art-of-fermentation/"&gt;The Art of Fermentation&lt;/a&gt; and I'm making back-slopped room temperature yogurt, sauerkraut, kim chi, preserved lemons and best of all fermented garlic and chili sauce. Unfortunately the flies got the first salami experiment. &lt;/p&gt;
&lt;p&gt;Being a data measurement nerd I wanted to check the the temperature and humidity were about right for each of these ferments - especially the salami. Leaving raw pork meat in the basement for a month and then expecting to eat it seems scary. All the books/internet sites state that getting the temperature range (7 deg C to 15 deg C) and humidity range (75 %RH to 80 %RH) correct is crucial to making salami safely. &lt;/p&gt;
&lt;p&gt;Here's my plans for a battery powered data-logger based on a &lt;a href="https://store.micropython.org/#/store"&gt;pyboard&lt;/a&gt; and a DHT11 sensor. The battery usage (3 x AA Ni-MH) is low enough that the logger can be left in the hot water cupboard or the basement or on the bench along with the latest ferment experiment for at least a month before the batteries need recharging.&lt;/p&gt;
&lt;p&gt;There's several micro-python data-loggers &lt;a href="http://wiki.micropython.org/SDdatalogger"&gt;out there&lt;/a&gt; and other &lt;a href="https://github.com/peterhinch/micropython-micropower"&gt;projects&lt;/a&gt; to investigate minimum power usage on a pyboard. This one is really simple and comes with the files for a nice 3D printed box.&lt;/p&gt;
&lt;p&gt;The box has been frankensteined from at least four things on thingiverse. The outer box is a resized version of &lt;a href="http://www.thingiverse.com/make:75833"&gt;this RAMPS box&lt;/a&gt;. The battery pack is from this &lt;a href="http://www.thingiverse.com/thing:456900"&gt;flexing battery holder&lt;/a&gt; with the bottom cut off it. The pyboard tray is based on this &lt;a href="http://www.thingiverse.com/thing:1373291"&gt;thing&lt;/a&gt; with a &lt;a href="http://www.thingiverse.com/thing:267438"&gt;coin cell holder&lt;/a&gt; tacked on the end. The coin cell (CR1632, 3V) provides battery backup to keep the pyboard real time clock (RTC) going when the main battery pack or USB power are not connected.&lt;/p&gt;
&lt;p&gt;&lt;img alt="circuit" src="./images/datalogger_circuit.png" /&gt;&lt;/p&gt;
&lt;h2&gt;Construction&lt;/h2&gt;
&lt;p&gt;&lt;img alt="printed parts" src="./images/data_logger_prints.JPG" /&gt;&lt;/p&gt;
&lt;h3&gt;Printing&lt;/h3&gt;
&lt;p&gt;Get the files from &lt;a href="http://www.thingiverse.com/thing:1857224"&gt;thingiverse&lt;/a&gt; and print out one each of:  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;battery holder&lt;/li&gt;
&lt;li&gt;pytray&lt;/li&gt;
&lt;li&gt;base&lt;/li&gt;
&lt;li&gt;lid&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you print them in this order you can wire up the batteries while the main box prints. &lt;/p&gt;
&lt;p&gt;&lt;img alt="wired up" src="./images/data_logger_innards.JPG" /&gt;&lt;/p&gt;
&lt;h3&gt;Wire up battery holder and install switch.&lt;/h3&gt;
&lt;p&gt;For the battery terminals strip the ends of some solid hook up wire and wrap the bare wire through the holes at each end of each battery compartment. Wire the compartments together so the batteries are in series. I put the two outside batteries with the negative terminal at the spring end and reversed the middle battery. Whichever way you do it, mark the holder with + and - signs to match.&lt;/p&gt;
&lt;p&gt;Add a switch in one of the lines and add a 90 degree terminal header to go into the pyboard. Hot glue the switch on to the front of the battery holder.&lt;/p&gt;
&lt;h3&gt;Wire up and install coin battery.&lt;/h3&gt;
&lt;p&gt;Poke the stripped end of a piece of hook up wire through each hole in the coin battery holder. Push the battery in place to hold the wires in. The negative terminal wire goes along the channel on the underside of the pytray and through the hole to the topside. Strip the other ends of the wire and connect to th GND and VBAT terminals on the pyboard. These won't need to be removed very often so I didn't bother with  a connector.&lt;/p&gt;
&lt;h3&gt;Wire up DHT11 sensor.&lt;/h3&gt;
&lt;p&gt;My DHT11 sensor came mounted on a small breakout board that included the required 10 k pullup resistor needed between the data pin and VCC. If you have a bare sensor you'll need to add this resistor. Wire the sensor to a 90 degree header as shown. The more accurate DHT22 sensor could be used instead. In this case make sure to change the sensor type in &lt;em&gt;main.py&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Glue the battery holder into the box base (more hot glue) and slide in the pytray&lt;/p&gt;
&lt;p&gt;&lt;img alt="finshed" src="./images/data_logger_closed.JPG" /&gt;&lt;/p&gt;
&lt;p&gt;The box can be closed with four screws on the front, but I tend to hold it closed with a rubber band. The DHT11 sensor can be slipped in to the band to hold it in place.&lt;/p&gt;
&lt;h2&gt;Code setup&lt;/h2&gt;
&lt;p&gt;First of all with the coin battery connected and the main battery pack switched off set the clock on the pyboard to the correct time. Make a  USB connection to the pyboard and open an &lt;a href="http://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/repl.html"&gt;REPL terminal&lt;/a&gt;. &lt;/p&gt;
&lt;p&gt;In Linux, to get a REPL prompt, open a terminal and run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;screen /dev/ttyACM0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With the python REPL prompt up type in the following (using the current time and date values):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;
&lt;span class="n"&gt;rtc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;RTC&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;rtc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="mi"&gt;2016&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;24&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;17&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mo"&gt;05&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; 
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The clock should now continue to give the correct time whether the pyboard main battery pack is off or on. To be safe I always turn off the main battery pack before connecting the pyboard to the computer via USB. &lt;/p&gt;
&lt;p&gt;Copy &lt;em&gt;dht.py&lt;/em&gt; and &lt;em&gt;main.py&lt;/em&gt; to a micro SD card, insert the card into the pyboard and turn the battery pack on. The orange LED should blink every time a measurement is made. The dht library used is from &lt;a href="https://github.com/polygontwist/uPython-DHT22"&gt;polygontwist on github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;main.py&lt;/em&gt;  &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pyb&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;dht&lt;/span&gt;

&lt;span class="n"&gt;dht&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;init&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data_pin&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;X12&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="n"&gt;the_dhttype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;DHT11&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;led&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LED&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;rtc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;RTC&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;led2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;LED&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;led2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;on&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;led2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;off&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;measureDHT&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;millis&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;                            
    &lt;span class="n"&gt;RH&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;dht&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;measure&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;led&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;on&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;log&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;/sd/dht.csv&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;a&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;dt&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;rtc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;datetime&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;{0}-{1:02d}-{2:02d} {4:02d}:{5:02d}:{6:02d}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;dt&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;, {},{},{}&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;RH&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;T&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; 
    &lt;span class="n"&gt;led&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;off&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;rtc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wakeup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;300000&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# wake time in milliseconds&lt;/span&gt;
&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;measureDHT&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;pyb&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="c1"&gt;# sleep in low power mode, waiting for the next wakeup trigger&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The program measures the DHT sensor every 5 minutes (300 000 milliseconds) opens a file on the SD card, writes the values along with the timestamp, closes the file and goes back to low power mode. &lt;/p&gt;
&lt;p&gt;To retrieve data, turn off the battery pack (while the orange LED is off). Remove the SD card and put it in a SD card reader. You should have a file &lt;em&gt;dht.csv&lt;/em&gt; that looks like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;2016-10-29 11:35:54, 1562,63,16
2016-10-29 11:40:53, 1651,63,16
2016-10-29 11:45:53, 1696,63,16
2016-10-29 11:50:53, 1740,62,16
2016-10-29 11:55:53, 1786,61,17
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Alternatively the pyboard can be used as a SD reader. Turn off the battery pack and connect it via a USB cable to a PC. The board will automaticallically run &lt;em&gt;main.py&lt;/em&gt; again and start data logging. To stop this hold down the &lt;em&gt;USR&lt;/em&gt; button and press then release the  &lt;em&gt;RST&lt;/em&gt; button on the board. The orange and green LEDs will cyle through a pattern. Release the &lt;em&gt;USR&lt;/em&gt; button when only the orange LED is lit. This will stop &lt;em&gt;main.py&lt;/em&gt; being run and the PC operating system should mount the SD card as an external drive.  The data file &lt;em&gt;dht.csv&lt;/em&gt; can then be copied for analysis.&lt;/p&gt;
&lt;p&gt;This box and code could easily be re-purposed to read other sensors.&lt;/p&gt;
&lt;hr /&gt;</summary><category term="make"></category></entry></feed>