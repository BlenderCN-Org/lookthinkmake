<!doctype html>
<html lang="">	
<head>
	<meta charset="utf-8"/>
	<title>Structure Synth meets Sverchok - Generative Art inside Blender - Look Think Make</title>	
	<meta name="author" content="elfnor">
	

	<meta name="description" content="After using the "Matrix Iterate" node to generate some of the simpler structures from Structure Synth. I started to think about how to implement more of Structure Synth directly in Blender. It turned out to be remarkably simple using a scripted node and some existing python code. Structure Synth uses ...">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link href='http://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Rock+Salt' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://www.elfnor.com/theme/css/main.css" type="text/css" />
		

    <link href="http://www.elfnor.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Look Think Make Atom Feed" />
</head>
	
<body>

    <div class="container">
	  
	  <header role="banner">
	    <div class="feeds">
	        <a href="http://www.elfnor.com/feeds/all.atom.xml" rel="alternate"><img src="/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
	    </div>
	      <nav class="pages">
			  <a href="http://www.elfnor.com/pages/about-me.html">About Me</a>
-			  <a href="http://www.elfnor.com/pages/galleries.html">Galleries</a>
	      </nav>
		<a href="http://www.elfnor.com" class="title">Look Think Make</a>
      </header>
	
	  <div class="wrapper">

		  <div role="main" class="content">
	<article class="full">
			
		<h1>Structure Synth meets Sverchok - Generative Art inside Blender</h1>
		
<div class="metadata">
  <time datetime="2015-03-08T22:00:00" pubdate>Sun 08 March 2015</time>
    <address class="vcard author">
      by <a class="url fn" href="http://www.elfnor.com/author/elfnor.html">elfnor</a>
    </address>
  in <a href="http://www.elfnor.com/category/think.html">think</a>
<p class="tags">tagged <a href="http://www.elfnor.com/tag/make.html">make</a>, <a href="http://www.elfnor.com/tag/think.html">think</a>, <a href="http://www.elfnor.com/tag/blender.html">blender</a>, <a href="http://www.elfnor.com/tag/sverchok.html">sverchok</a>, <a href="http://www.elfnor.com/tag/structuresynth.html">structuresynth</a></p></div>		
		<p><img alt="Nouveau Dr Seuss" src="/images/seuss_nouveu_11.png" /></p>
<p>After using the <a href="http://www.elfnor.com/simple-sverchok-05-interpolate-and-iterate-matrix.html">"Matrix Iterate"</a> node to generate some of the simpler structures from <a href="http://structuresynth.sourceforge.net/">Structure Synth</a>. I started to think about how to implement more of Structure Synth directly in Blender. It turned out to be remarkably simple using a scripted node and some existing python code.</p>
<p>Structure Synth uses a domain specific language called eisenscript to define a design grammar to construct 3D structures (LSystems). Here's the eisenscript for a structure with 6 spirals.</p>
<div class="highlight"><pre><span class="n">set</span> <span class="n">maxdepth</span> <span class="mi">400</span>

<span class="n">r0</span>

<span class="n">rule</span> <span class="n">r0</span> <span class="p">{</span>
  <span class="mi">3</span> <span class="o">*</span> <span class="p">{</span> <span class="n">rz</span> <span class="mi">120</span>  <span class="p">}</span> <span class="n">R1</span>
  <span class="mi">3</span> <span class="o">*</span> <span class="p">{</span> <span class="n">rz</span> <span class="mi">120</span> <span class="p">}</span> <span class="n">R2</span>
<span class="p">}</span>

<span class="n">rule</span> <span class="n">R1</span> <span class="p">{</span>
  <span class="p">{</span> <span class="n">x</span> <span class="mf">1.3</span> <span class="n">rx</span> <span class="mf">1.57</span> <span class="n">rz</span> <span class="mi">6</span> <span class="n">ry</span> <span class="mi">3</span> <span class="n">s</span> <span class="mf">0.99</span><span class="p">}</span> <span class="n">R1</span>
  <span class="p">{</span> <span class="n">s</span> <span class="mi">4</span> <span class="p">}</span> <span class="n">sphere</span>
<span class="p">}</span>

<span class="n">rule</span> <span class="n">R2</span> <span class="p">{</span>
  <span class="p">{</span> <span class="n">x</span> <span class="o">-</span><span class="mf">1.3</span> <span class="n">rz</span> <span class="mi">6</span> <span class="n">ry</span> <span class="mi">3</span> <span class="n">s</span> <span class="mf">0.99</span><span class="p">}</span> <span class="n">R2</span>
  <span class="p">{</span> <span class="n">s</span> <span class="mi">4</span> <span class="p">}</span>  <span class="n">sphere</span>
<span class="p">}</span>
</pre></div>


<p><img alt="matrix iterate sample image" src="/images/matrix_iterate_13.png" /></p>
<p>An eisenscript consists of a list of rules. Each rule contains a set of instructions. That instruction can either be to place an object or to call another rule. That call can be to to the rule doing the calling in a recursive fashion. Each instruction also has an associated transform to scale rotate or move the current coordinate system. The original eisenscript also allowed transforms on the colour and transparency of the object.</p>
<p>The above structure can be easily implemented in Sverchok using the "Matrix Iterate" node as shown in the <a href="http://www.elfnor.com/simple-sverchok-05-interpolate-and-iterate-matrix.html">previous post</a>. </p>
<p>The interesting bit is that each rule can have multiple definitions that are called randomly according to the weight assigned to each rule definition. This allows structures with random branches and other complexities. This random choice of rule is bit harder to implement directly in Sverchok nodes but I'm thinking about it...</p>
<p>In the meantime searching the web, I couldn't find anyone who had included a parser for eisenscript files in Blender (there is one in <a href="http://meshlab.sourceforge.net/">MeshLab</a>), but I did find that <a href="http://github.prideout.net/">Little Grasshopper</a> (aka Philip Rideout) had written some <a href="https://github.com/prideout/lsystem">scripts</a> in python go and c++ to work with Structure Synth type LSystems and RenderMan. </p>
<p>He uses an xml form of eisenscript to define the design grammar. The above script looks like this in Philip's xml:</p>
<div class="highlight"><pre><span class="nt">&lt;rules</span> <span class="na">max_depth=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">&quot;entry&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;call</span> <span class="na">count=</span><span class="s">&quot;3&quot;</span> <span class="na">transforms=</span><span class="s">&quot;rz 120&quot;</span> <span class="na">rule=</span><span class="s">&quot;R1&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;call</span> <span class="na">count=</span><span class="s">&quot;3&quot;</span> <span class="na">transforms=</span><span class="s">&quot;rz 120&quot;</span> <span class="na">rule=</span><span class="s">&quot;R2&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/rule&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">&quot;R1&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;call</span> <span class="na">transforms=</span><span class="s">&quot;tx 1.3 rx 1.57 rz 6 ry 3 sa 0.99&quot;</span> <span class="na">rule=</span><span class="s">&quot;R1&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;instance</span> <span class="na">transforms=</span><span class="s">&quot;sa 4&quot;</span> <span class="na">shape=</span><span class="s">&quot;sphere&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/rule&gt;</span>
    <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">&quot;R2&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;call</span> <span class="na">transforms=</span><span class="s">&quot;tx -1.3 rz 6 ry 3 sa 0.99&quot;</span> <span class="na">rule=</span><span class="s">&quot;R2&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;instance</span> <span class="na">transforms=</span><span class="s">&quot;sa 4&quot;</span> <span class="na">shape=</span><span class="s">&quot;sphere&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/rule&gt;</span>
<span class="nt">&lt;/rules&gt;</span>
</pre></div>


<p>From Little Grasshopper's <a href="http://prideout.net/blog/?p=44">post</a></p>
<blockquote>
<p>Every description must contain at least one rule named entry; this is the starting point for the evaluator. Note the mini-language used for specifying transformations. It’s a simple string consisting of translations, rotations, and scaling operations. For example, <code>tx n</code>  means “translate n units along the x-axis”, <code>ry theta</code>  means “rotate theta degrees about the y-axis”, and <code>sa f</code> means “scale all axes by a factor of f“.</p>
</blockquote>
<p>In Philip's github <a href="https://github.com/prideout/lsystem">repo</a> he provides a python module (<code>LSystem.py</code>) that parses the above type of xml strings and outputs a list of matrices and the name of the object to place at the location, scale and rotation defined by the matrix. This code is beautifully separated from any code used to implement or render the geometry and is perfect to incorporate in <a href="http://nikitron.cc.ua/sverchok_en.html">Sverchok</a>.</p>
<p>The module <code>LSystem.py</code> has two dependencies, <code>elementtree</code> for parsing the xml and <code>euclid</code> for the matrix multiplication. I replaced <code>elementtree</code> with <code>xml.etree.cElementTree</code> avaliable in the standard python included with Blender, and replaced <code>euclid</code> with the Blender <code>mathutils</code> module. </p>
<p>I also added a break to the code on reaching maximum number of objects as I kept crashing/locking Blender/Sverchok when I got more then a few 10s of thousands of objects. </p>
<p>From there all we need is a simple "Scripted Node" in Sverchok with the following code:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">sverchok.data_structure</span> <span class="kn">import</span> <span class="n">Matrix_listing</span>

<span class="kn">import</span> <span class="nn">LSystem_blender</span> <span class="kn">as</span> <span class="nn">LSystem</span>
<span class="kn">import</span> <span class="nn">GA_xml</span>

<span class="kn">import</span> <span class="nn">imp</span>

<span class="n">max_mats</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="k">def</span> <span class="nf">sv_main</span><span class="p">(</span><span class="n">rseed</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="n">in_sockets</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;rseed&#39;</span><span class="p">,</span> <span class="n">rseed</span><span class="p">]]</span>

    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">GA_xml</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">GA_xml</span><span class="o">.</span><span class="n">Library</span><span class="p">[</span><span class="s">&quot;Default&quot;</span><span class="p">]</span>
    <span class="n">lsys</span> <span class="o">=</span> <span class="n">LSystem</span><span class="o">.</span><span class="n">LSystem</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">max_mats</span><span class="p">)</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="n">lsys</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">seed</span> <span class="o">=</span> <span class="n">rseed</span><span class="p">)</span>

    <span class="n">mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shapes</span> <span class="k">if</span> <span class="n">shape</span><span class="p">]</span> 
    <span class="n">mat_out</span> <span class="o">=</span>  <span class="n">Matrix_listing</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

    <span class="n">out_sockets</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="s">&#39;matrices&#39;</span><span class="p">,</span> <span class="n">mat_out</span><span class="p">]]</span>

    <span class="k">return</span> <span class="n">in_sockets</span><span class="p">,</span> <span class="n">out_sockets</span>
</pre></div>


<p>Note: The node code above is given to show how simple a Sverchok scripted node can be. I have since updated the code on my repository to do some other stuff.</p>
<p>See <a href="http://sverchok.readthedocs.org/en/latest/nodes/generator/scripted_intro.html">here</a> if you need help working with the "Scripted Node" in Sverchok.</p>
<p>That was too simple and it just works! It's fast too. Before doing this I played around trying to implement the object generation directly in Blender python and had trouble getting fast enough code, let alone getting lost in <code>bpy.ops</code> and <code>bpy.context</code> calls.</p>
<p>The latest version of <code>LSystem_blender.py</code> and my Sverchok nodes is available on my github <a href="https://github.com/elfnor/lsystem">repo</a> (forked from prideout/lsystem).</p>
<p>To use the GA node in Blender first install the <a href="http://nikitron.cc.ua/sverchok_en.html">Sverchok</a> addon. Download the lsystem code from <a href="https://github.com/elfnor/lsystem">github</a>. Then load the three python files in the Blender directory (<code>LSystem_blender.py, GA_xml.py, GA_node.py</code>) as separate text blocks into a blend file. Add a "Scripted Node" to a Sverchok node tree. On the node select the <code>GA_node.py</code> code from the lower drop down. Then click the plugin icon to the right of this field. The node should turn blue with some inputs and outputs. Wire the matrices output to a "Viewer Draw" node and you should see some geometry as below.</p>
<p><img alt="GA node diagram" src="/images/Lsystem_pipe_05.blend.png" /></p>
<p>The node has an input "rseed" which is used to set the random number generator. For a rule set that includes multiple definitions of rules, changing this will change the structure. </p>
<p>The Library of xml rule sets is stored in the <code>GA_xml.py</code> module. This allows you to easily change the rule set. In the last line of code <code>Library["Default"] = Library["Tree"]</code> change <code>Tree</code> to any of the other examples. You can also change the rules or add new ones. The geometry should change in the 3D View after clicking the "Update Node Tree" button in the Sverchok panel.</p>
<p>My computer chokes if I try to feed too many matrices into Sverchok. The <code>max matrices</code> sets a limit in the node to the number of matrices calculated and displayed. Change this depending on you and your computer's ability to cope with lockups and crashes. Note that the nodes get recalculated when you open a blend file. Saving a blend file with an LSystem that has a long calculating time will make it slow to open.</p>
<p>Using the matrices output allows a separate object to be placed at each location. The vertices input and the mesh (vertices, edges, faces) output "skins" the mesh into a much smaller number of objects. The mask node can be used if the rule set has more than one type of object. I'll describe these further in the next post but here's a preview of the mesh mode (with a subdivison modifier applied).</p>
<p><img alt="GA tube nodes and render/screenshot" src="/images/Fern.blend.png" /></p>
<hr />	

	</article>

	<div class="comments">
	<h2>Comments !</h2>
	    <div id="disqus_thread"></div>
	    <script type="text/javascript">
	       var disqus_identifier = "structure-synth-meets-sverchok-generative-art-inside-blender.html";
	       (function() {
	       var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	       dsq.src = 'http://lookthinkmake.disqus.com/embed.js';
	       (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	      })();
	    </script>
	</div>

		  </div>	
		  
		  <div class="sidebar">

	        <nav>
		  <h2>Recent Posts</h2>
			<ul class="archive">
	
			      <li>
<a href="http://www.elfnor.com/blender-adventures-with-hyperbolic-planes.html" rel="bookmark" title="Permalink to Blender Adventures with Hyperbolic Planes">Blender Adventures with Hyperbolic Planes</a>
  <time datetime="2015-04-15T22:00:00" pubdate>Wed 15 April 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a><a href="http://www.elfnor.com/tag/.html">  </a></p></a>      			      </li>
		
	
			      <li>
<a href="http://www.elfnor.com/structure-synth-meets-sverchok-animation.html" rel="bookmark" title="Permalink to Structure Synth meets Sverchok - Animation">Structure Synth meets Sverchok - Animation</a>
  <time datetime="2015-03-22T22:00:00" pubdate>Sun 22 March 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a><a href="http://www.elfnor.com/tag/structuresynth.html">structuresynth  </a></p></a>      			      </li>
		
	
			      <li>
<a href="http://www.elfnor.com/structure-synth-meets-sverchok-mesh-mode.html" rel="bookmark" title="Permalink to Structure Synth meets Sverchok - Mesh mode">Structure Synth meets Sverchok - Mesh mode</a>
  <time datetime="2015-03-15T22:00:00" pubdate>Sun 15 March 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a><a href="http://www.elfnor.com/tag/structuresynth.html">structuresynth  </a></p></a>      			      </li>
		
	
			      <li>
<a href="http://www.elfnor.com/structure-synth-meets-sverchok-generative-art-inside-blender.html" rel="bookmark" title="Permalink to Structure Synth meets Sverchok - Generative Art inside Blender">Structure Synth meets Sverchok - Generative Art inside Blender</a>
  <time datetime="2015-03-08T22:00:00" pubdate>Sun 08 March 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a><a href="http://www.elfnor.com/tag/structuresynth.html">structuresynth  </a></p></a>      			      </li>
		
	
			      <li>
<a href="http://www.elfnor.com/shaders-for-sverchok-03-image-texture-node.html" rel="bookmark" title="Permalink to Shaders for Sverchok 03 - Image Texture Node">Shaders for Sverchok 03 - Image Texture Node</a>
  <time datetime="2015-03-07T22:00:00" pubdate>Sat 07 March 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a></p></a>      			      </li>
		
	
			      <li>
<a href="http://www.elfnor.com/shaders-for-sverchok-02-vertex-colors.html" rel="bookmark" title="Permalink to Shaders for Sverchok 02 - Vertex Colors">Shaders for Sverchok 02 - Vertex Colors</a>
  <time datetime="2015-02-26T22:00:00" pubdate>Thu 26 February 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a></p></a>      			      </li>
		
	
			      <li>
<a href="http://www.elfnor.com/shaders-for-sverchok-01-object-info-node.html" rel="bookmark" title="Permalink to Shaders for Sverchok 01 - Object Info node.">Shaders for Sverchok 01 - Object Info node.</a>
  <time datetime="2015-02-22T22:00:00" pubdate>Sun 22 February 2015</time>
<p class="tags">tags: <a href="http://www.elfnor.com/tag/make.html">make  </a><a href="http://www.elfnor.com/tag/think.html">think  </a><a href="http://www.elfnor.com/tag/blender.html">blender  </a><a href="http://www.elfnor.com/tag/sverchok.html">sverchok  </a></p></a>      			      </li>
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
	
                        </u1>
		
		</nav>

	          <h2>Categories</h2>
	          <ul class = "social">
		      <li> <a href="http://www.elfnor.com/archives.html">everything </a></li>	
	              <li ><a href="http://www.elfnor.com/category/look.html">look</a></li>
	              <li ><a href="http://www.elfnor.com/category/make.html">make</a></li>
	              <li class="active"><a href="http://www.elfnor.com/category/think.html">think</a></li>
	          </ul>
	        

	          <aside>
	          <h2>Elsewhere</h2>
			    <ul class="social">
				  <li><a href="http://elfnor.deviantart.com">on deviant art</a><i></i></li>
				  <li><a href="http://www.thingiverse.com/elfnor">on thingiverse</a><i></i></li>
				  <li><a href="https://github.com/elfnor">on github</a><i></i></li>
			    </ul>
			  </aside>

		
		  </div>

	  </div>

      <footer>
		<p role="contentinfo">
		  © 2013 elfnor - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Theme <a href="https://github.com/fle/pelican-simplegrey"> pelican-simplegrey</a>, modified.
    	</p>

	  </footer>	

	</div>
<!-- Start of StatCounter Code for Default Guide -->
<script type="text/javascript">
var sc_project=9900594; 
var sc_invisible=1; 
var sc_security="efb2c43c"; 
var scJsHost = (("https:" == document.location.protocol) ?
"https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" +
scJsHost+
"statcounter.com/counter/counter.js'></"+"script>");
</script>
<noscript><div class="statcounter"><a title="free hit
counter" href="http://statcounter.com/" target="_blank"><img
class="statcounter"
src="http://c.statcounter.com/9900594/0/efb2c43c/1/"
alt="free hit counter"></a></div></noscript>
<!-- End of StatCounter Code for Default Guide -->
</body>
</html>